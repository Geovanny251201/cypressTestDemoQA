name: Cypress Tests with Testmo

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  cypress-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4

    - name: Instalar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18

    - name: Instalar dependencias
      run: npm ci

    - name: Ejecutar pruebas Cypress y generar resultados JUnit
      run: |
        npx cypress run --reporter junit --reporter-options "mochaFile=results/test-results-[hash].xml,toConsole=true"
      
    - name: Instalar testmo-cli
      run: npm install -g @testmo/testmo-cli

    - name: Subir resultados a Testmo
      env:
        TESTMO_TOKEN: ${{ secrets.TESTMO_TOKEN }}
      run: |
        testmo automation:run:submit \
          --instance https://testpracticeqa.testmo.net \
          --project-id 1 \
          --name "Cypress GitHub Run" \
          --source github-actions \
          --results results/*.xml

    - name: Subir videos y capturas si falla
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: cypress-artifacts
        path: |
          cypress/videos
          cypress/screenshots
